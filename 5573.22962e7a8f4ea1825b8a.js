"use strict";(("undefined"!=typeof self?self:this).webpackChunk_subwallet_sub_connect=("undefined"!=typeof self?self:this).webpackChunk_subwallet_sub_connect||[]).push([[5573],{85573:(e,t,r)=>{r.d(t,{Os:()=>N,SolanaPrivateKeyProvider:()=>M,kL:()=>I});var n=r(56666),a=r(35681),s=r(17391),i=r(4268),o=r(77257),c=r(17022),d=r.n(c),h=r(58094),p=r(98818),u=r(99234),g=r(64592),l=r.n(g),m=r(48834).Buffer;function y(e){return(t,r,n,a)=>"solana_chainId"===t.method?(r.result=e,a()):n()}function v(e){return(t,r,n,a)=>"solana_provider_config"===t.method?(r.result=e,a()):n()}function f(e){const{chainId:t}=e;return(0,s.UZ)([y(t),v(e)])}function w(e){let{getAccounts:t}=e;return(0,s.Pk)((async(e,r,n)=>{const{method:a}=e;if("getAccounts"!==a)return n();if(!t)throw new Error("WalletMiddleware - opts.getAccounts not provided");const s=await t(e);r.result=s}))}function P(e){let{requestAccounts:t}=e;return(0,s.Pk)((async(e,r,n)=>{const{method:a}=e;if("requestAccounts"!==a)return n();if(!t)throw new Error("WalletMiddleware - opts.requestAccounts not provided");const s=await t(e);r.result=s}))}function b(e,t){return(0,s.Pk)((async(r,n,a)=>{const{method:s}=r;if(s!==e)return a();if(!t)throw new Error(`WalletMiddleware - ${e} not provided`);const i=await t(r);n.result=i}))}function O(e){const{getAccounts:t,requestAccounts:r,signTransaction:n,signAndSendTransaction:a,signAllTransactions:i,signMessage:o,getPrivateKey:c,getSecretKey:d}=e;return(0,s.UZ)([P({requestAccounts:r}),w({getAccounts:t}),b("signTransaction",n),b("signAndSendTransaction",a),b("signAllTransactions",i),b("signMessage",o),b("solanaPrivateKey",c),b("private_key",c),b("solanaSecretKey",d)])}function E(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function C(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?E(Object(r),!0).forEach((function(t){(0,n.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):E(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class A extends o.Zk{constructor(e){let{config:t,state:r}=e;super({config:{chainConfig:C(C({},t.chainConfig),{},{chainNamespace:i.CHAIN_NAMESPACES.SOLANA})},state:r})}async switchChain(e){throw i.RM.unsupportedOperation("Chain switching is not supported by this adapter")}async setupProvider(e){const t=new s.eI,r=O(this.getProviderHandlers(e));t.push(r);const n=f(this.config.chainConfig);t.push(n);const i=this.getInjectedProviderProxy(e);i&&t.push(i);const o=(0,a.Xj)(t);this.updateProviderEngineProxy(o),await this.lookupNetwork()}async lookupNetwork(){const{chainConfig:e}=this.config;return this.update({chainId:e.chainId}),e.chainId||""}getInjectedProviderProxy(e){}}function S(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function j(e){return(0,s.Pk)((async(t,r,a)=>{const s=await e.request(function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?S(Object(r),!0).forEach((function(t){(0,n.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):S(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},t));r.result=s}))}class I extends A{getProviderHandlers(e){return(e=>({requestAccounts:async()=>e.publicKey?[d().encode(e.publicKey.toBytes())]:[],getAccounts:async()=>e.publicKey?[d().encode(e.publicKey.toBytes())]:[],getPrivateKey:async()=>{throw h.ethErrors.rpc.methodNotSupported()},getSecretKey:async()=>{throw h.ethErrors.rpc.methodNotSupported()},signTransaction:async t=>await e.signTransaction(t.params.message),signMessage:async t=>(await e.signMessage(t.params.message,t.params.display)).signature,signAllTransactions:async t=>{var r,n;if(null===(r=t.params)||void 0===r||!r.message||null===(n=t.params)||void 0===n||!n.message.length)throw h.ethErrors.rpc.invalidParams("message");return await e.signAllTransactions(t.params.message)},signAndSendTransaction:async t=>({signature:(await e.signAndSendTransaction(t.params.message)).signature})}))(e)}getInjectedProviderProxy(e){return j(e)}}function k(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function K(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?k(Object(r),!0).forEach((function(t){(0,n.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):k(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class N extends o.Zk{constructor(e){let{config:t,state:r}=e;super({config:{chainConfig:K(K({},t.chainConfig),{},{chainNamespace:i.CHAIN_NAMESPACES.SOLANA})},state:r})}async switchChain(e){await this.provider.request({method:"switchSolanaChain",params:[{chainId:e.chainId}]})}async addChain(e){super.addChain(e),await this.provider.request({method:"addNewChainConfig",params:[{chainId:e.chainId,chainName:e.displayName,rpcUrls:[e.rpcTarget],blockExplorerUrls:[e.blockExplorer],nativeCurrency:{name:e.tickerName,symbol:e.ticker,decimals:e.decimals||18}}]})}async setupProvider(e){this.handleInjectedProviderUpdate(e),await this.setupEngine(e)}async lookupNetwork(){if(!this.provider)throw h.ethErrors.provider.custom({message:"Torus solana provider is not initialized",code:4902});const{chainId:e}=this.config.chainConfig,t=await this.provider.request({method:"solana_chainId"}),r=(0,i.H2)(t.toString())?t:`0x${parseInt(t,10).toString(16)}`;if(e!==r)throw i.Ty.rpcConnectionError(`Invalid network, net_version is: ${r}, expected: ${e}`);return this.update({chainId:r}),this.provider.emit("connect",{chainId:this.state.chainId}),this.provider.emit("chainChanged",this.state.chainId),this.state.chainId}async setupEngine(e){const t=(e=>({requestAccounts:async()=>await e.request({method:"solana_requestAccounts",params:{}}),getAccounts:async()=>await e.request({method:"solana_requestAccounts",params:{}}),getPrivateKey:async()=>{throw h.ethErrors.rpc.methodNotSupported()},getSecretKey:async()=>{throw h.ethErrors.rpc.methodNotSupported()},signMessage:async t=>{var r;if(null===(r=t.params)||void 0===r||!r.message)throw h.ethErrors.rpc.invalidParams("message");return await e.signMessage(t.params.message)},signTransaction:async t=>{var r;if(null===(r=t.params)||void 0===r||!r.message)throw h.ethErrors.rpc.invalidParams("message");const n=t.params.message;return await e.signTransaction(n)},signAndSendTransaction:async t=>{var r;if(null===(r=t.params)||void 0===r||!r.message)throw h.ethErrors.rpc.invalidParams("message");const n=t.params.message;return{signature:await e.sendTransaction(n)}},signAllTransactions:async t=>{var r,n;if(null===(r=t.params)||void 0===r||!r.message||null===(n=t.params)||void 0===n||!n.message.length)throw h.ethErrors.rpc.invalidParams("message");const a=t.params.message;return await e.signAllTransactions(a)}}))(e),r=O(t),n=j(e),i=new s.eI;i.push(r),i.push(n);const o=(0,a.Xj)(i);this.updateProviderEngineProxy(o),await this.lookupNetwork()}async handleInjectedProviderUpdate(e){e.on("accountsChanged",(async e=>{this.provider.emit("accountsChanged",e)})),e.on("chainChanged",(async t=>{const r=(0,i.H2)(t)?t:`0x${parseInt(t,10).toString(16)}`;this.configure({chainConfig:K(K({},this.config.chainConfig),{},{chainId:r})}),await this.setupProvider(e)}))}}function T(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function x(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?T(Object(r),!0).forEach((function(t){(0,n.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):T(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}class M extends o.Zk{constructor(e){let{config:t,state:r}=e;super({config:{chainConfig:x(x({},t.chainConfig),{},{chainNamespace:i.CHAIN_NAMESPACES.SOLANA})},state:r})}async enable(){if(!this.state.privateKey)throw h.ethErrors.provider.custom({message:"Private key is not found in state, plz pass it in constructor state param",code:4902});return await this.setupProvider(this.state.privateKey),this._providerEngineProxy.request({method:"eth_accounts"})}getEd25519Key(e){return(0,u.getED25519Key)(e).sk.toString("hex")}async setupProvider(e){const t=await async function(e){let{privKey:t,getProviderEngineProxy:r}=e;if("string"!=typeof t)throw i.Ty.invalidParams("privKey must be a string");const n=p.Keypair.fromSecretKey(m.from(t,"hex"));return{requestAccounts:async()=>[n.publicKey.toBase58()],getAccounts:async()=>[n.publicKey.toBase58()],getPrivateKey:async()=>t,getSecretKey:async()=>d().encode(n.secretKey),signTransaction:async e=>{var t;if(null===(t=e.params)||void 0===t||!t.message)throw h.ethErrors.rpc.invalidParams("message");const r=e.params.message;return void 0!==r.version||r instanceof p.VersionedTransaction?r.sign([n]):r.partialSign(n),r},signMessage:async e=>{var t;if(null===(t=e.params)||void 0===t||!t.message)throw h.ethErrors.rpc.invalidParams("message");return l().sign.detached(e.params.message,n.secretKey)},signAndSendTransaction:async e=>{var t;if(null===(t=e.params)||void 0===t||!t.message)throw h.ethErrors.rpc.invalidParams("message");const a=r();if(!a)throw h.ethErrors.provider.custom({message:"Provider is not initialized",code:4902});const s=e.params.message;return void 0!==s.version||s instanceof p.VersionedTransaction?s.sign([n]):s.partialSign(n),{signature:await a.request({method:"sendTransaction",params:[m.from(s.serialize()).toString("base64"),{encoding:"base64",preflightCommitment:"confirmed"}]})}},signAllTransactions:async e=>{var t,r,a;if(null===(t=e.params)||void 0===t||!t.message||null===(r=e.params)||void 0===r||!r.message.length)throw h.ethErrors.rpc.invalidParams("message");const s=null===(a=e.params)||void 0===a?void 0:a.message;for(const e of s||[]){const t=e;void 0!==t.version||t instanceof p.VersionedTransaction?t.sign([n]):t.partialSign(n)}return s}}}({privKey:e,getProviderEngineProxy:this.getProviderEngineProxy.bind(this)}),r=O(t),n=new s.eI,{networkMiddleware:o}=function(e){const{rpcTarget:t}=e,r=(0,a.v$)({rpcTarget:t});return{networkMiddleware:(0,s.UZ)([f(e),r]),fetchMiddleware:r}}(this.config.chainConfig);n.push(this.getChainSwitchMiddleware()),n.push(this.getAccountMiddleware()),n.push(r),n.push(o);const c=(0,a.Xj)(n);this.updateProviderEngineProxy(c),await this.lookupNetwork()}async updateAccount(e){if(!this._providerEngineProxy)throw h.ethErrors.provider.custom({message:"Provider is not initialized",code:4902});await this._providerEngineProxy.request({method:"solanaPrivateKey"})!==e.privateKey&&(await this.setupProvider(e.privateKey),this._providerEngineProxy.emit("accountsChanged",{accounts:await this._providerEngineProxy.request({method:"requestAccounts"})}))}async switchChain(e){if(!this._providerEngineProxy)throw h.ethErrors.provider.custom({message:"Provider is not initialized",code:4902});const t=this.getChainConfig(e.chainId);this.update({chainId:"loading"}),this.configure({chainConfig:t});const r=await this._providerEngineProxy.request({method:"solanaPrivateKey"});await this.setupProvider(r)}async lookupNetwork(){if(!this._providerEngineProxy)throw h.ethErrors.provider.custom({message:"Provider is not initialized",code:4902});const e=await this._providerEngineProxy.request({method:"getHealth",params:[]}),{chainConfig:t}=this.config;if("ok"!==e)throw i.Ty.rpcConnectionError(`Failed to lookup network for following rpc target: ${t.rpcTarget}`);return this.update({chainId:t.chainId}),this.state.chainId!==t.chainId&&(this.provider.emit("chainChanged",this.state.chainId),this.provider.emit("connect",{chainId:this.state.chainId})),this.state.chainId}getChainSwitchMiddleware(){return function(e){let{addNewChainConfig:t,switchSolanaChain:r}=e;return(0,s.UZ)([b("addSolanaChain",t),b("switchSolanaChain",r)])}({addNewChainConfig:async e=>{if(!e.params)throw h.ethErrors.rpc.invalidParams("Missing request params");const{chainId:t,chainName:r,rpcUrls:n,blockExplorerUrls:a,nativeCurrency:s}=e.params;if(!t)throw h.ethErrors.rpc.invalidParams("Missing chainId in chainParams");if(!n||0===n.length)throw h.ethErrors.rpc.invalidParams("Missing rpcUrls in chainParams");if(!s)throw h.ethErrors.rpc.invalidParams("Missing nativeCurrency in chainParams");this.addChain({chainNamespace:i.CHAIN_NAMESPACES.SOLANA,chainId:t,ticker:(null==s?void 0:s.symbol)||"SOL",tickerName:(null==s?void 0:s.name)||"Solana",displayName:r,rpcTarget:n[0],blockExplorer:(null==a?void 0:a[0])||"",decimals:(null==s?void 0:s.decimals)||9})},switchSolanaChain:async e=>{if(!e.params)throw h.ethErrors.rpc.invalidParams("Missing request params");if(!e.params.chainId)throw h.ethErrors.rpc.invalidParams("Missing chainId");await this.switchChain(e.params)}})}getAccountMiddleware(){return function(e){let{updatePrivatekey:t}=e;return(0,s.UZ)([b("updateAccount",t)])}({updatePrivatekey:async e=>{if(!e.params)throw h.ethErrors.rpc.invalidParams("Missing request params");if(!e.params.privateKey)throw h.ethErrors.rpc.invalidParams("Missing privateKey");const{privateKey:t}=e.params;await this.updateAccount({privateKey:t})}})}}(0,n.Z)(M,"getProviderInstance",(async e=>{const t=new M({config:{chainConfig:e.chainConfig}});return await t.setupProvider(e.privKey),t}))}}]);